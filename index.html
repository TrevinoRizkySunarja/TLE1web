<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Feed Simulator</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <header class="appbar">
    <div class="brand">
      <svg width="26" height="26" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a7 7 0 0 1 7 7v6.5l1.6 2.77a1 1 0 0 1-1.74 1L18 17.5V9a6 6 0 1 0-12 0v8.5l-0.86 1.5a1 1 0 0 1-1.74-1L5 15.5V9a7 7 0 0 1 7-7Z"/></svg>
      <span>AI Feed Simulator</span>
    </div>
    <div class="mode-chip">
      <span class="dot"></span> In Control
    </div>
  </header>

  <main class="page">
    <section class="composer card">
      <h2>Plaats je content</h2>
      <form id="composerForm">
        <div class="row">
          <img class="avatar" src="https://ui-avatars.com/api/?name=U&background=6a0dad&color=fff" alt="Jouw avatar"/>
          <input type="text" name="username" placeholder="Gebruikersnaam (optioneel)" />
        </div>
        <textarea name="text" rows="3" placeholder="Schrijf iets origineels… met spelfouten of rare zinnen, ik fix het 😉"></textarea>

        <div class="upload-row">
          <input type="file" name="image" id="image" accept="image/*"/>
          <label for="image" class="btn ghost">Afbeelding kiezen</label>
          <input type="text" name="imgdesc" placeholder="Korte beschrijving (voor alt-tekst, optioneel)"/>
        </div>

        <button class="btn primary" type="submit">Posten & AI-perfect maken</button>
        <p class="hint">Elke post is <strong>5s zichtbaar</strong> en dan volgt de volgende.</p>
      </form>
    </section>

    <section class="phone-wrap">
      <div class="phone">
        <div class="storybar"><div class="progress" id="progress"></div></div>
        <div id="feed" class="feed">
          <div class="empty">Nog geen posts… Plaats er één hierboven.</div>
        </div>
        <nav class="bottomnav">
          <button aria-label="Home" class="active">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8Z"/></svg>
          </button>
          <button aria-label="Search">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 14 15.5l.27.28v.79L20 21.5 21.5 20l-6-6Zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14Z"/></svg>
          </button>
          <button aria-label="Create">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19 11H13V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
          </button>
          <button aria-label="Profile">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5a5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 5v1h16v-1c0-2.83-3.67-5-8-5Z"/></svg>
          </button>
        </nav>
      </div>
    </section>
  </main>

  <footer class="foot">
    © 2025 AI Feed Simulator — demo
  </footer>

  <template id="postTpl">
    <article class="post card">
      <header class="post-head">
        <div class="left">
          <img class="avatar" src="" alt="Avatar"/>
          <div class="meta">
            <div class="username"></div>
            <div class="time">nu</div>
          </div>
        </div>
        <div class="right">
          <span class="pill ai">AI Optimized</span>
          <button class="icon-btn" title="Meer">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 10a2 2 0 1 0 0 4a2 2 0 0 0 0-4Zm6 0a2 2 0 1 0 0 4a2 2 0 0 0 0-4Zm6 0a2 2 0 1 0 0 4a2 2 0 0 0 0-4Z"/></svg>
          </button>
        </div>
      </header>

      <div class="image-wrap">
        <img class="image" src="" alt=""/>
        <div class="badge">Perfected</div>
      </div>

      <div class="caption">
        <p class="text"></p>
        <p class="hashtags"></p>
      </div>

      <div class="toggles">
        <label class="switch">
          <input class="toggle-original" type="checkbox">
          <span>Toon origineel</span>
        </label>
      </div>

      <footer class="actions">
        <button class="icon-btn" aria-label="Like">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12.1 18.55 11 17.5C5.4 12.36 2 9.28 2 6a4 4 0 0 1 7-2.65A4 4 0 0 1 22 6c0 3.28-3.4 6.36-9 11.5l-0.9 1.05Z"/></svg>
        </button>
        <button class="icon-btn" aria-label="Comment">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M20 17.17V5H4v12h12.17L20 21M4 3h16a2 2 0 0 1 2 2v18l-4-4H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"/></svg>
        </button>
        <button class="icon-btn" aria-label="Share">
          <svg viewBox="0 0 24 24"><path fill="currentColor" d="M14 9V5l7 7-7 7v-4H3v-6h11Z"/></svg>
        </button>
      </footer>
    </article>
  </template>

  <script>
    // --- CONFIG: your API base ---
    const API_BASE = 'http://127.0.0.1:5174';

  async function fetchPerfected(text, imgDesc="") {
  const r = await fetch('/api/rewrite.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, imgDesc })
  });
  if (!r.ok) {
    const t = await r.text().catch(()=>r.statusText);
    throw new Error(`HTTP ${r.status} ${t}`);
  }
  return r.json(); // {hook, caption, alt, hashtags[]}
}


    const form = document.getElementById('composerForm');
    const tpl = document.getElementById('postTpl');
    const feed = document.getElementById('feed');
    const progress = document.getElementById('progress');
    const posts = [];
    let index = 0, timer = null;
    const FEED_INTERVAL = 5000;

    function animateProgress() {
      progress.style.transition = 'none';
      progress.style.width = '0%';
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          progress.style.transition = `width ${FEED_INTERVAL}ms linear`;
          progress.style.width = '100%';
        });
      });
    }

    function renderPost(p) {
      feed.innerHTML = '';
      const node = tpl.content.cloneNode(true);

      node.querySelector('.avatar').src =
        `https://ui-avatars.com/api/?name=${encodeURIComponent(p.user||'U')}&background=6a0dad&color=fff`;
      node.querySelector('.username').textContent = p.user || 'user_demo';

      const imgEl = node.querySelector('.image');
      if (p.img) {
        imgEl.src = p.img;
        imgEl.alt = p.alt;
      } else {
        imgEl.src = 'https://placehold.co/800x800/1f1f1f/aaaaaa?text=Geen+afbeelding';
        imgEl.alt = 'Placeholder';
      }

      const textEl = node.querySelector('.text');
      const tagEl  = node.querySelector('.hashtags');
      textEl.textContent = `【Hook】 ${p.hook}\n\n${p.caption}`;
      tagEl.textContent  = (p.hashtags || []).join(' ');

      node.querySelector('.toggle-original').addEventListener('change', (e) => {
        if (e.target.checked) {
          textEl.textContent = p.original || '—';
          tagEl.textContent  = '';
          feed.querySelector('.badge').textContent = 'Original';
          feed.querySelector('.pill.ai').textContent = 'Original View';
        } else {
          textEl.textContent = `【Hook】 ${p.hook}\n\n${p.caption}`;
          tagEl.textContent  = (p.hashtags || []).join(' ');
          feed.querySelector('.badge').textContent = 'Perfected';
          feed.querySelector('.pill.ai').textContent = 'AI Optimized';
        }
      });

      feed.appendChild(node);
      animateProgress();
    }

    function nextPost() {
      if (!posts.length) return;
      renderPost(posts[index % posts.length]);
      index++;
    }
    function startLoop() {
      if (timer) clearInterval(timer);
      nextPost();
      timer = setInterval(nextPost, FEED_INTERVAL);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const rawText  = fd.get('text')?.toString() ?? '';
      const user     = fd.get('username')?.toString() || 'user_demo';
      const imgdesc  = fd.get('imgdesc')?.toString() || '';
      const file     = fd.get('image');

      // image → DataURL (demo only)
      let dataUrl = null;
      if (file && file.size) {
        dataUrl = await new Promise((resolve) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.readAsDataURL(file);
        });
      }

      let aiOut;
      try {
        aiOut = await fetchPerfected(rawText, imgdesc);
      } catch (err) {
        console.error('AI rewrite error:', err);
        alert('AI rewrite failed. Using original text.');
        aiOut = { hook: rawText.slice(0,80), caption: rawText, alt: imgdesc, hashtags: [] };
      }

      posts.push({
        user,
        original: rawText,
        hook: aiOut.hook,
        caption: aiOut.caption,
        hashtags: aiOut.hashtags,
        alt: aiOut.alt,
        img: dataUrl
      });

      form.reset();
      document.querySelector('.empty')?.remove();
      if (posts.length === 1) startLoop();
    });
  </script>
</body>
</html>
